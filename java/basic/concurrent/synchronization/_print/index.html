<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="canonical" type="text/html" href="https://hamhuo.xyz/java/basic/concurrent/synchronization/">
<link rel="alternate" type="application/rss&#43;xml" href="https://hamhuo.xyz/java/basic/concurrent/synchronization/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>synchronized | 海阔集</title>
<meta name="description" content="Threads communicate primarily by sharing access to fields and the objects reference fields refer to. This form of communication is extremely efficient, but makes two kinds of errors possible: thread interference and memory consistency errors. The tool needed to prevent these errors is synchronization.">
<meta property="og:url" content="https://hamhuo.xyz/java/basic/concurrent/synchronization/">
  <meta property="og:site_name" content="海阔集">
  <meta property="og:title" content="synchronized">
  <meta property="og:description" content="Threads communicate primarily by sharing access to fields and the objects reference fields refer to. This form of communication is extremely efficient, but makes two kinds of errors possible: thread interference and memory consistency errors. The tool needed to prevent these errors is synchronization.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="website">

  <meta itemprop="name" content="synchronized">
  <meta itemprop="description" content="Threads communicate primarily by sharing access to fields and the objects reference fields refer to. This form of communication is extremely efficient, but makes two kinds of errors possible: thread interference and memory consistency errors. The tool needed to prevent these errors is synchronization.">
  <meta itemprop="wordCount" content="928">
  <meta itemprop="keywords" content="并发编程,Synchronized">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="synchronized">
  <meta name="twitter:description" content="Threads communicate primarily by sharing access to fields and the objects reference fields refer to. This form of communication is extremely efficient, but makes two kinds of errors possible: thread interference and memory consistency errors. The tool needed to prevent these errors is synchronization.">
<link rel="preload" href="/scss/main.min.023240d665d6ea36df214aa4d82691f4a70d71a02d1740f34f44227813c4b7d9.css" as="style" integrity="sha256-AjJA1mXW6jbfIUqk2CaR9KcNcaAtF0DzT0QieBPEt9k=" crossorigin="anonymous">
<link href="/scss/main.min.023240d665d6ea36df214aa4d82691f4a70d71a02d1740f34f44227813c4b7d9.css" rel="stylesheet" integrity="sha256-AjJA1mXW6jbfIUqk2CaR9KcNcaAtF0DzT0QieBPEt9k=" crossorigin="anonymous">
<script
  src="https://code.jquery.com/jquery-3.7.1.min.js"
  integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
  crossorigin="anonymous"></script>
<script defer
  src="https://unpkg.com/lunr@2.3.9/lunr.min.js"
  integrity="sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli"
  crossorigin="anonymous"></script>

  </head>
  <body class="td-section">
    <header>
      <nav class="td-navbar js-navbar-scroll" data-bs-theme="dark">
<div class="container-fluid flex-column flex-md-row">
  <a class="navbar-brand" href="/"><span class="navbar-brand__logo navbar-logo"><svg width="800" height="800" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M23.3 8.40007 21.82 6.40008C21.7248 6.27314 21.6008 6.17066 21.4583 6.10111 21.3157 6.03156 21.1586 5.99693 21 6.00008H11.2C11.0555 6.00007 10.9128 6.03135 10.7816 6.09177 10.6504 6.15219 10.5339 6.24031 10.44 6.35007L8.71998 8.35008C8.57227 8.53401 8.49435 8.76424 8.49998 9.00008V16.2901C8.50262 18.0317 9.19567 19.7013 10.4272 20.9328c1.2316 1.2316 2.9011 1.9246 4.6428 1.9273h1.86C18.6716 22.8574 20.3412 22.1644 21.5728 20.9328c1.2315-1.2315 1.9245-2.9011 1.9272-4.6427V9.00008C23.5 8.7837 23.4298 8.57317 23.3 8.40007z" fill="#ffcc80"/><path d="M29.78 28.38l-4-5C25.664 23.2321 25.5086 23.1198 25.3318 23.0562 25.1549 22.9925 24.9637 22.98 24.78 23.02L16 25 7.21999 23C7.03632 22.96 6.84507 22.9725 6.6682 23.0362 6.49133 23.0998 6.33598 23.2121 6.21999 23.36l-4 5C2.10392 28.5064 2.03116 28.6823 2.00995 28.8679 1.98874 29.0534 2.01993 29.2413 2.09999 29.41 2.17815 29.5839 2.3044 29.7319 2.46385 29.8364 2.62331 29.9409 2.80933 29.9977 2.99999 30H29C29.1885 29.9995 29.373 29.9457 29.5322 29.8448 29.6914 29.744 29.8189 29.6002 29.9 29.43 29.98 29.2613 30.0112 29.0734 29.99 28.8879 29.9688 28.7023 29.8961 28.5264 29.78 28.38z" fill="#01579b"/><path d="M29.29 6.00003l-13-4C16.0999 1.95002 15.9001 1.95002 15.71 2.00003l-13 4c-.21258.06419-.39774.19732-.5263.37838C2.05515 6.55947 1.99052 6.77817 2 7.00003 1.9917 7.22447 2.0592 7.44518 2.19163 7.62659c.13242.1814.32207.31295.53837.37344L15.73 11.6C15.906 11.6534 16.094 11.6534 16.27 11.6l13-3.59997C29.4863 7.93954 29.6759 7.80799 29.8084 7.62659 29.9408 7.44518 30.0083 7.22447 30 7.00003 30.0095 6.77817 29.9448 6.55947 29.8163 6.37841 29.6877 6.19735 29.5026 6.06422 29.29 6.00003z" fill="#01579b"/><path d="M11.22 6C11.0756 5.99999 10.9328 6.03127 10.8016 6.09169 10.6704 6.15211 10.5539 6.24023 10.46 6.35l-1.72 2C8.58509 8.53114 8.49998 8.76166 8.5 9v7.29C8.50264 18.0317 9.19569 19.7012 10.4272 20.9328c1.2316 1.2315 2.9011 1.9246 4.6428 1.9272H16V6H11.22z" fill="#ffe0b2"/><path d="M7.21999 23C7.03632 22.96 6.84507 22.9725 6.6682 23.0362 6.49133 23.0998 6.33598 23.2121 6.21999 23.36l-4 5C2.10392 28.5064 2.03116 28.6823 2.00995 28.8679 1.98874 29.0534 2.01993 29.2413 2.09999 29.41 2.17815 29.5839 2.3044 29.7319 2.46385 29.8364 2.62331 29.9409 2.80933 29.9977 2.99999 30H16V25L7.21999 23z" fill="#0277bd"/><path d="M15.71 2.00002l-13 4C2.49742 6.06422 2.31226 6.19734 2.1837 6.3784c-.12855.18107-.19318.39977-.1837.62162C1.9917 7.22447 2.0592 7.44518 2.19163 7.62658 2.32405 7.80799 2.5137 7.93954 2.73 8.00002L15.73 11.6C15.8194 11.6146 15.9106 11.6146 16 11.6V2.00002C15.9039 1.98469 15.8061 1.98469 15.71 2.00002z" fill="#0277bd"/><path d="M2.73 8.00003l5.77 1.56V16.29C8.50264 18.0317 9.19569 19.7013 10.4272 20.9328c1.2316 1.2315 2.9011 1.9246 4.6428 1.9272h1.86C18.6717 22.8574 20.3412 22.1643 21.5728 20.9328c1.2315-1.2315 1.9246-2.9011 1.9272-4.6428V9.56003l5.77-1.56C29.4863 7.93954 29.6759 7.80799 29.8084 7.62659 29.9408 7.44518 30.0083 7.22447 30 7.00003 30.0095 6.77817 29.9448 6.55947 29.8163 6.37841 29.6877 6.19735 29.5026 6.06422 29.29 6.00003l-13-4C16.0999 1.95002 15.9001 1.95002 15.71 2.00003l-13 4c-.21258.06419-.39774.19732-.5263.37838C2.05515 6.55947 1.99052 6.77817 2 7.00003 1.9917 7.22447 2.0592 7.44518 2.19163 7.62659c.13242.1814.32207.31295.53837.37344zM21.5 16.29C21.4974 17.5013 21.015 18.6621 20.1586 19.5186 19.3021 20.3751 18.1412 20.8574 16.93 20.86H15.07C13.8588 20.8574 12.6979 20.3751 11.8414 19.5186 10.985 18.6621 10.5026 17.5013 10.5 16.29V10.11l5.23 1.45C15.906 11.6134 16.094 11.6134 16.27 11.56l5.23-1.45v6.18zM16 4.05003l9.44 2.95-9.44 2.56-9.44-2.56 9.44-2.95z" fill="#263238"/><path d="M25.78 23.38C25.664 23.2321 25.5086 23.1198 25.3318 23.0562 25.1549 22.9925 24.9637 22.98 24.78 23.02L16 25 7.21999 23C7.03632 22.96 6.84507 22.9725 6.6682 23.0362 6.49133 23.0998 6.33598 23.2121 6.21999 23.36l-4 5C2.10392 28.5064 2.03116 28.6823 2.00995 28.8679 1.98874 29.0534 2.01993 29.2413 2.09999 29.41 2.17815 29.5839 2.3044 29.7319 2.46385 29.8364 2.62331 29.9409 2.80933 29.9977 2.99999 30H29C29.1885 29.9995 29.373 29.9457 29.5322 29.8448 29.6914 29.744 29.8189 29.6002 29.9 29.43 29.98 29.2613 30.0112 29.0734 29.99 28.8879 29.9688 28.7023 29.8961 28.5264 29.78 28.38l-4-5zM5.07999 28l2.31-2.89L15.78 27C15.9251 27.0299 16.0748 27.0299 16.22 27l8.39-1.87L26.92 28H5.07999z" fill="#263238"/></svg></span><span class="navbar-brand__name">海阔集</span></a>
  <div class="td-navbar-nav-scroll ms-md-auto" id="main_navbar">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" href="/leetcode/"><span>Alog</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link active" href="/java/"><span>Doc</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/graphicsai/"><span>Graphics and AI</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/interview/"><span>Interview</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/school/"><span>课程归档</span></a>
      </li>
      <li class="td-light-dark-menu nav-item dropdown">
        <svg xmlns="http://www.w3.org/2000/svg" class="d-none">
  <symbol id="check2" viewBox="0 0 16 16">
    <path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"/>
  </symbol>
  <symbol id="circle-half" viewBox="0 0 16 16">
    <path d="M8 15A7 7 0 1 0 8 1v14zm0 1A8 8 0 1 1 8 0a8 8 0 0 1 0 16z"/>
  </symbol>
  <symbol id="moon-stars-fill" viewBox="0 0 16 16">
    <path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"/>
    <path d="M10.794 3.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387a1.734 1.734 0 0 0-1.097 1.097l-.387 1.162a.217.217 0 0 1-.412 0l-.387-1.162A1.734 1.734 0 0 0 9.31 6.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387a1.734 1.734 0 0 0 1.097-1.097l.387-1.162zM13.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.156 1.156 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.156 1.156 0 0 0-.732-.732l-.774-.258a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"/>
  </symbol>
  <symbol id="sun-fill" viewBox="0 0 16 16">
    <path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"/>
  </symbol>
</svg>

<button class="btn btn-link nav-link dropdown-toggle d-flex align-items-center"
        id="bd-theme"
        type="button"
        aria-expanded="false"
        data-bs-toggle="dropdown"
        data-bs-display="static"
        aria-label="Toggle theme (auto)">
  <svg class="bi my-1 theme-icon-active"><use href="#circle-half"></use></svg>
</button>
<ul class="dropdown-menu dropdown-menu-end" aria-labelledby="bd-theme-text">
  <li>
    <button type="button" class="dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
      <svg class="bi me-2 opacity-50"><use href="#sun-fill"></use></svg>
      Light
      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg>
    </button>
  </li>
  <li>
    <button type="button" class="dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
      <svg class="bi me-2 opacity-50"><use href="#moon-stars-fill"></use></svg>
      Dark
      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg>
    </button>
  </li>
  <li>
    <button type="button" class="dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
      <svg class="bi me-2 opacity-50"><use href="#circle-half"></use></svg>
      Auto
      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg>
    </button>
  </li>
</ul>

      </li>
      </ul>
  </div>
  <div class="d-none d-lg-block">
    <div class="td-search td-search--offline">
  <div class="td-search__icon"></div>
  <input
    type="search"
    class="td-search__input form-control"
    placeholder="Search this site…"
    aria-label="Search this site…"
    autocomplete="off"
    
    data-offline-search-index-json-src="/offline-search-index.4d6d607ba0db25a4f293480f944fd109.json"
    data-offline-search-base-href="/"
    data-offline-search-max-results="10"
  >
</div>
  </div>
</div>
</nav>
    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 ps-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This is the multi-page printable view of this section.
<a href="#" onclick="print();return false;">Click here to print</a>.
</p><p>
<a href="/java/basic/concurrent/synchronization/">Return to the regular view of this page</a>.
</p>
</div>



<h1 class="title">synchronized</h1>
<div class="lead">Threads communicate primarily by sharing access to fields and the objects reference fields refer to. This form of communication is extremely efficient, but makes two kinds of errors possible: thread interference and memory consistency errors. The tool needed to prevent these errors is synchronization.</div>




    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-d935226cca7410a10e890a281d87cd7c">atomic</a></li>


    
  
    
    
	
<li>2: <a href="#pg-d84cd7f670a6480268128d704794cf04">Memory Consistency Errors</a></li>


    
  
    
    
	
<li>3: <a href="#pg-94fa4a7164aa50dc3f7e72b40ea93cd8">ReadWriteLock</a></li>


    
  
    
    
	
<li>4: <a href="#pg-44806d547d596a7ad4a84a926b25d7d0">ReentrantLock重入锁</a></li>


    
  

    </ul>


<div class="content">
      <blockquote>
<p>在 Java 中，关键字 synchronized 可以保证在同一个时刻，只有一个线程可以执行某个方法或者某个代码块(主要是对方法或者代码块中存在共享数据的操作)
synchronized 的另外一个重要的作用，synchronized 可保证一个线程的变化(主要是共享数据的变化)被其他线程所看到</p></blockquote>
<p>The Java programming language provides two basic synchronization idioms: </p>
<p><em>synchronized methods</em> and <em>synchronized statements</em>.</p>
<p>we are talking about <code>synchronization</code> idioms</p>
<h4 id="synchronization-idioms"><code>synchronization</code> idioms<a class="td-heading-self-link" href="#synchronization-idioms" aria-label="Heading self-link"></a></h4>
<meta name="baidu-site-verification" content="codeva-23xblvQ4Jb" /><p>To make a method synchronized, simply add the <code>synchronized</code> keyword to its declaration:</p>
<div class="highlight"><pre tabindex="0" style="color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#e78284">public</span> <span style="color:#e78284">class</span> <span style="color:#e5c890">SynchronizedCounter</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e78284">private</span> <span style="color:#e78284">int</span> c <span style="color:#99d1db;font-weight:bold">=</span> 0;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e78284">public</span> <span style="color:#e78284">synchronized</span> <span style="color:#e78284">void</span> <span style="color:#8caaee">increment</span>() {
</span></span><span style="display:flex;"><span>        c<span style="color:#99d1db;font-weight:bold">++</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e78284">public</span> <span style="color:#e78284">synchronized</span> <span style="color:#e78284">void</span> <span style="color:#8caaee">decrement</span>() {
</span></span><span style="display:flex;"><span>        c<span style="color:#99d1db;font-weight:bold">--</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e78284">public</span> <span style="color:#e78284">synchronized</span> <span style="color:#e78284">int</span> <span style="color:#8caaee">value</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#ca9ee6">return</span> c;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>making these methods synchronized has two effects</p>
<ul>
<li> methods on the same object to interleave is impossible, other thread must blocked until executing thread finish</li>
<li>when a synchronized method exits, Object lock auto release(<em>we will talk later</em>), <em>any subsequent invocation</em> of a synchronized method for the same object must get lock before execute which  automatically establishes a happens-before relationship. This guarantees that changes to the state of the object are visible to all threads.</li>
</ul>
<blockquote>
<p>Note:
constructors cannot be synchronized, That&rsquo;s doesn&rsquo;t make sense, only thread creates an Object have access to it while it is being constructed</p></blockquote>
<blockquote>
<p>Note:
When constructing an object that will be shared between threads, be very careful that a reference to the object does not &ldquo;leak&rdquo; prematurely.</p>
<p>if we maintain an List in one thread. which hold all instances, the constructor will look like</p></blockquote>
<div class="highlight"><pre tabindex="0" style="color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span> <span style="color:#737994;font-style:italic">//...new List</span>
</span></span><span style="display:flex;"><span> instances.<span style="color:#8caaee">add</span>(<span style="color:#ca9ee6">this</span>);
</span></span></code></pre></div><blockquote>
<p>If you do that, other thread can call the instances (this) before the construction finish. Which will cause problem.</p></blockquote>
<p>all reads or writes to that object&rsquo;s variables are done through <code>synchronized</code> methods with one exception <code>final</code> field, which can not modify after constructed, can be safely read through non-synchronized methods</p>
<h4 id="intrinsic-locks">Intrinsic Locks<a class="td-heading-self-link" href="#intrinsic-locks" aria-label="Heading self-link"></a></h4>
<meta name="baidu-site-verification" content="codeva-23xblvQ4Jb" /><p>we already know <code>sunchronization</code> is to avoid mem-consist problem , How does that work?</p>
<p>Synchronization is built around an internal entity known as the <em>intrinsic lock</em> or <em>monitor lock</em> (an entity simply as a &ldquo;monitor.&rdquo;) with two job</p>
<ul>
<li>enforcing exclusive access to an object&rsquo;s state</li>
<li>establishing happens-before relationships that are essential to visibility.</li>
</ul>
<p><em><strong>Every object has an intrinsic lock associated with it.</strong></em> when one thread need  exclusive and consistent access to an Object, have to acquire lock and release when finish
There is no chance to get the same lock when other thread own that. The other thread will block when it attempts to acquire the lock.</p>
<blockquote>
<p><em><strong>The lock release occurs even if the return was caused by an uncaught exception.</strong></em></p></blockquote>
<p>we also have static sync method, which is associated with a class, not an object.</p>
<div class="highlight"><pre tabindex="0" style="color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#e78284">public</span> <span style="color:#e78284">class</span> <span style="color:#e5c890">MyClass</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e78284">private</span> <span style="color:#e78284">static</span> <span style="color:#e78284">int</span> staticField <span style="color:#99d1db;font-weight:bold">=</span> 0;  <span style="color:#737994;font-style:italic">// 静态字段</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e78284">private</span> <span style="color:#e78284">int</span> instanceField <span style="color:#99d1db;font-weight:bold">=</span> 0;       <span style="color:#737994;font-style:italic">// 实例字段</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#737994;font-style:italic">// 静态方法，访问静态字段</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e78284">public</span> <span style="color:#e78284">static</span> <span style="color:#e78284">synchronized</span> <span style="color:#e78284">void</span> <span style="color:#8caaee">incrementStaticField</span>() {
</span></span><span style="display:flex;"><span>        staticField<span style="color:#99d1db;font-weight:bold">++</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#737994;font-style:italic">// 实例方法，访问实例字段</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e78284">public</span> <span style="color:#e78284">synchronized</span> <span style="color:#e78284">void</span> <span style="color:#8caaee">incrementInstanceField</span>() {
</span></span><span style="display:flex;"><span>        instanceField<span style="color:#99d1db;font-weight:bold">++</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>the thread acquires the intrinsic lock for the <code>Class</code> object associated with the class, which is different from any instance lock.</p>
<h4 id="synchronized-statements">Synchronized Statements<a class="td-heading-self-link" href="#synchronized-statements" aria-label="Heading self-link"></a></h4>
<meta name="baidu-site-verification" content="codeva-23xblvQ4Jb" /><p>Another way to create synchronized code is with <em>synchronized statements</em>.
Unlike synchronized methods, synchronized statements must specify the object that provides the intrinsic lock:</p>
<div class="highlight"><pre tabindex="0" style="color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#e78284">public</span> <span style="color:#e78284">void</span> <span style="color:#8caaee">addName</span>(String name) {
</span></span><span style="display:flex;"><span>    <span style="color:#e78284">synchronized</span>(<span style="color:#ca9ee6">this</span>) {
</span></span><span style="display:flex;"><span>        lastName <span style="color:#99d1db;font-weight:bold">=</span> name;
</span></span><span style="display:flex;"><span>        nameCount<span style="color:#99d1db;font-weight:bold">++</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    nameList.<span style="color:#8caaee">add</span>(name);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>In that case, <code>addName</code> has to sync change with lastName and nameCount, but also needs to avoid synchronizing invocations of other objects&rsquo; methods. (this may cause a deadlock, will talk later)</p>
<p> Without synchronized statements, there would have to be a separate, unsynchronized method for the sole purpose of invoking <code>nameList.add</code>.</p>
<p>Synchronized statements are also useful for improving concurrency with fine-grained synchronization.</p>
<p>for example, we have two field c1 and c2, they never used together and we should keep all field sync, there&rsquo;s no reason to prevent an update of c1 from being interleaved with an update of c2, since they wont rely on others.</p>
<p>Instead of using synchronized methods or otherwise using the lock associated with <code>this</code>, we create two objects solely to provide locks.</p>
<div class="highlight"><pre tabindex="0" style="color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#e78284">public</span> <span style="color:#e78284">class</span> <span style="color:#e5c890">MsLunch</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e78284">private</span> <span style="color:#e78284">long</span> c1 <span style="color:#99d1db;font-weight:bold">=</span> 0;
</span></span><span style="display:flex;"><span>    <span style="color:#e78284">private</span> <span style="color:#e78284">long</span> c2 <span style="color:#99d1db;font-weight:bold">=</span> 0;
</span></span><span style="display:flex;"><span>    <span style="color:#e78284">private</span> Object lock1 <span style="color:#99d1db;font-weight:bold">=</span> <span style="color:#ca9ee6">new</span> Object();
</span></span><span style="display:flex;"><span>    <span style="color:#e78284">private</span> Object lock2 <span style="color:#99d1db;font-weight:bold">=</span> <span style="color:#ca9ee6">new</span> Object();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e78284">public</span> <span style="color:#e78284">void</span> <span style="color:#8caaee">inc1</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#e78284">synchronized</span>(lock1) {
</span></span><span style="display:flex;"><span>            c1<span style="color:#99d1db;font-weight:bold">++</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e78284">public</span> <span style="color:#e78284">void</span> <span style="color:#8caaee">inc2</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#e78284">synchronized</span>(lock2) {
</span></span><span style="display:flex;"><span>            c2<span style="color:#99d1db;font-weight:bold">++</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>In that case, two variable can update  interleaved.</p>
<blockquote>
<p>these two objects considered &ldquo;locks&rdquo; not two instences</p></blockquote>
<h4 id="reentrant-synchronization">Reentrant Synchronization<a class="td-heading-self-link" href="#reentrant-synchronization" aria-label="Heading self-link"></a></h4>
<meta name="baidu-site-verification" content="codeva-23xblvQ4Jb" /><p>Recall that a thread cannot acquire a lock owned by another thread. But a thread <em>can</em> acquire a lock that it already owns.</p>
<p>Allowing a thread to acquire the same lock more than once enables <em>reentrant synchronization</em>. This describes a situation where synchronized code, directly or indirectly, invokes a method that also contains synchronized code, and both sets of code use the same lock.</p>
<p>Without reentrant synchronization, synchronized code would have to take many additional precautions to avoid having a thread cause itself to block. (dead lock we will talk later)</p>
<blockquote>
<p>next
<a href="/java/basic/concurrent/synchronization/atomic/">atomic</a></p></blockquote>
<p>synchronized 关键字最主要有以下 3 种应用方式：</p>
<ul>
<li>
<p>同步方法，为当前对象加锁，进入同步代码前要获得当前对象的锁；</p>
</li>
<li>
<p>同步静态方法，为当前类加锁，进入同步代码前要获得当前类的锁；</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#e78284">public</span> <span style="color:#e78284">class</span> <span style="color:#e5c890">AccountingSyncClass</span> <span style="color:#e78284">implements</span> Runnable {
</span></span><span style="display:flex;"><span>    <span style="color:#e78284">static</span> <span style="color:#e78284">int</span> i <span style="color:#99d1db;font-weight:bold">=</span> 0;
</span></span><span style="display:flex;"><span>    <span style="color:#737994;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic">     * 同步静态方法,锁是当前class对象，也就是
</span></span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic">     * AccountingSyncClass类对应的class对象
</span></span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e78284">public</span> <span style="color:#e78284">static</span> <span style="color:#e78284">synchronized</span> <span style="color:#e78284">void</span> <span style="color:#8caaee">increase</span>() {
</span></span><span style="display:flex;"><span>        i<span style="color:#99d1db;font-weight:bold">++</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#737994;font-style:italic">// 非静态,访问时锁不一样不会发生互斥</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e78284">public</span> <span style="color:#e78284">synchronized</span> <span style="color:#e78284">void</span> <span style="color:#8caaee">increase4Obj</span>() {
</span></span><span style="display:flex;"><span>        i<span style="color:#99d1db;font-weight:bold">++</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#8caaee;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e78284">public</span> <span style="color:#e78284">void</span> <span style="color:#8caaee">run</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#ca9ee6">for</span>(<span style="color:#e78284">int</span> j<span style="color:#99d1db;font-weight:bold">=</span>0;j<span style="color:#99d1db;font-weight:bold">&lt;</span>1000000;j<span style="color:#99d1db;font-weight:bold">++</span>){
</span></span><span style="display:flex;"><span>            increase();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#e78284">public</span> <span style="color:#e78284">static</span> <span style="color:#e78284">void</span> <span style="color:#8caaee">main</span>(String<span style="color:#99d1db;font-weight:bold">[]</span> args) <span style="color:#e78284">throws</span> InterruptedException {
</span></span><span style="display:flex;"><span>        <span style="color:#737994;font-style:italic">//new新实例</span>
</span></span><span style="display:flex;"><span>        Thread t1<span style="color:#99d1db;font-weight:bold">=</span><span style="color:#ca9ee6">new</span> Thread(<span style="color:#ca9ee6">new</span> AccountingSyncClass());
</span></span><span style="display:flex;"><span>        <span style="color:#737994;font-style:italic">//new新实例</span>
</span></span><span style="display:flex;"><span>        Thread t2<span style="color:#99d1db;font-weight:bold">=</span><span style="color:#ca9ee6">new</span> Thread(<span style="color:#ca9ee6">new</span> AccountingSyncClass());
</span></span><span style="display:flex;"><span>        <span style="color:#737994;font-style:italic">//启动线程</span>
</span></span><span style="display:flex;"><span>        t1.<span style="color:#8caaee">start</span>();t2.<span style="color:#8caaee">start</span>();
</span></span><span style="display:flex;"><span>        t1.<span style="color:#8caaee">join</span>();t2.<span style="color:#8caaee">join</span>();
</span></span><span style="display:flex;"><span>        System.<span style="color:#8caaee">out</span>.<span style="color:#8caaee">println</span>(i);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic"> * 输出结果:
</span></span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic"> * 2000000
</span></span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic"> */</span>
</span></span></code></pre></div><ul>
<li>同步代码块，指定加锁对象，对给定对象加锁，进入同步代码库前要获得给定对象的锁。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#e78284">public</span> <span style="color:#e78284">class</span> <span style="color:#e5c890">AccountingSync2</span> <span style="color:#e78284">implements</span> Runnable {
</span></span><span style="display:flex;"><span>    <span style="color:#e78284">static</span> AccountingSync2 instance <span style="color:#99d1db;font-weight:bold">=</span> <span style="color:#ca9ee6">new</span> AccountingSync2(); <span style="color:#737994;font-style:italic">// 饿汉单例模式</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e78284">static</span> <span style="color:#e78284">int</span> i<span style="color:#99d1db;font-weight:bold">=</span>0;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8caaee;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e78284">public</span> <span style="color:#e78284">void</span> <span style="color:#8caaee">run</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#737994;font-style:italic">//省略其他耗时操作....</span>
</span></span><span style="display:flex;"><span>        <span style="color:#737994;font-style:italic">//使用同步代码块对变量i进行同步操作,锁对象为instance</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e78284">synchronized</span>(instance){
</span></span><span style="display:flex;"><span>            <span style="color:#ca9ee6">for</span>(<span style="color:#e78284">int</span> j<span style="color:#99d1db;font-weight:bold">=</span>0;j<span style="color:#99d1db;font-weight:bold">&lt;</span>1000000;j<span style="color:#99d1db;font-weight:bold">++</span>){
</span></span><span style="display:flex;"><span>                i<span style="color:#99d1db;font-weight:bold">++</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e78284">public</span> <span style="color:#e78284">static</span> <span style="color:#e78284">void</span> <span style="color:#8caaee">main</span>(String<span style="color:#99d1db;font-weight:bold">[]</span> args) <span style="color:#e78284">throws</span> InterruptedException {
</span></span><span style="display:flex;"><span>        Thread t1<span style="color:#99d1db;font-weight:bold">=</span><span style="color:#ca9ee6">new</span> Thread(instance);
</span></span><span style="display:flex;"><span>        Thread t2<span style="color:#99d1db;font-weight:bold">=</span><span style="color:#ca9ee6">new</span> Thread(instance);
</span></span><span style="display:flex;"><span>        t1.<span style="color:#8caaee">start</span>();t2.<span style="color:#8caaee">start</span>();
</span></span><span style="display:flex;"><span>        t1.<span style="color:#8caaee">join</span>();t2.<span style="color:#8caaee">join</span>();
</span></span><span style="display:flex;"><span>        System.<span style="color:#8caaee">out</span>.<span style="color:#8caaee">println</span>(i);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><blockquote>
<p>这里的锁指的是 Java 内置的隐式锁 monitor 也是 <code>synchronized</code> 封装好的实现
每个对象都有一个对象锁，不同的对象，他们的锁不会互相影响。</p></blockquote>
<blockquote>
<p>synchronized 与 happens before</p>
<p>[[JMM内存模型]]</p></blockquote>

</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d935226cca7410a10e890a281d87cd7c">1 - atomic</h1>
    <div class="lead">In programming, an atomic action is one that effectively happens all at once.</div>
	<p>In programming, an <em>atomic</em> action is one that effectively happens all at once.</p>
<p><em><strong>it either happens completely, or it doesn&rsquo;t happen at all.</strong></em></p>
<p>some method you can consider as atomic</p>
<ul>
<li>
<p>Reads and writes are atomic for reference variables and for most primitive variables <em><strong>(all types except <code>long</code> and <code>double</code>).</strong></em></p>
</li>
<li>
<p>Reads and writes are atomic for <em>all</em> variables declared <code>volatile</code></p>
</li>
</ul>
<p>Atomic actions cannot be interleaved, so they can be used without fear of thread interference.</p>
<h4 id="volatile-idiom"><code>volatile</code> idiom<a class="td-heading-self-link" href="#volatile-idiom" aria-label="Heading self-link"></a></h4>
<meta name="baidu-site-verification" content="codeva-23xblvQ4Jb" /><p>Reads and writes are atomic for <em>all</em> variables declared <code>volatile</code> (include double and long)</p>
<blockquote>
<p>In <strong>most 32-bit and 64-bit processors</strong>, a <code>long</code> or <code>double</code> variable requires <strong>two separate 32-bit reads or writes</strong> to access the full 64-bit value.</p>
<p>As a result, the operation of reading or writing a <code>long</code> or <code>double</code> is not guaranteed to be atomic at the hardware level.</p></blockquote>
<p>Using <code>volatile</code> can reduce the risk of mem-consist, because any write to volatile var will establishes a happen-before relationship with subsequent reads of that same variable</p>
<p>This means that changes to a <code>volatile</code> variable are always visible to other threads.</p>
<p>Using simple atomic variable access is more efficient than accessing these variables through synchronized code</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d84cd7f670a6480268128d704794cf04">2 - Memory Consistency Errors</h1>
    <div class="lead">Memory consistency errors occur when different threads have inconsistent views of what should be the same data.</div>
	<h5 id="what-is-a-memory-consistency-errors">What is a Memory Consistency Errors?<a class="td-heading-self-link" href="#what-is-a-memory-consistency-errors" aria-label="Heading self-link"></a></h5>
<meta name="baidu-site-verification" content="codeva-23xblvQ4Jb" /><blockquote>
<p>one of Thread <em><strong>most</strong></em> 3 errors</p></blockquote>
<p>different threads have inconsistent views of what should be the same data</p>
<p><img src="https://raw.githubusercontent.com/hamhuo-hub/HamPic/img/img/20250307230309089.png" alt="image.png"></p>
<p>The causes of memory consistency errors are complex, Fortunately, we don&rsquo;t have to need a detailed understanding of these causes.</p>
<p>we need a strategy for avoiding them.</p>
<p>The key to avoid MC errors is understanding <code>Happen-before</code> relationship</p>
<h5 id="happen-before"><code>Happen-before</code><a class="td-heading-self-link" href="#happen-before" aria-label="Heading self-link"></a></h5>
<meta name="baidu-site-verification" content="codeva-23xblvQ4Jb" /><p>a relationship guarantee memory writes by one specific statement are visible to another specific statement</p>
<p>for our example, Change in Thread A will visible to Thread B</p>
<p><img src="https://raw.githubusercontent.com/hamhuo-hub/HamPic/img/img/20250307231035238.png" alt="image.png"></p>
<blockquote>
<p>the value will lost, because there&rsquo;s no guarantee that thread A&rsquo;s change to <code>i</code> will be visible to thread B</p></blockquote>
<p>To create a happen-before relation, we can use <a href="content/en/java/Basic/Concurrent/synchronization/_index.md"><code>synchronization</code></a></p>
<p>We already see <code>happen-before</code> relationship</p>
<ul>
<li>
<p><code>Thread.start()</code>
when a statement invoke start(), every statement happen-before the statement also has same relation with new thread&rsquo;s statement</p>
<p>means that the effects of creating new thread are visible</p>
</li>
<li>
<p><code>Thread.join</code>
all the statements executed by the terminated thread have a happens-before relationship with all the statements following the successful join</p>
<p>the effect of terminated thread now visiable to the thread performed join</p>
</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-94fa4a7164aa50dc3f7e72b40ea93cd8">3 - ReadWriteLock</h1>
    <div class="lead">A ReadWriteLock maintains a pair of associated locks, one for read-only operations and one for writing.</div>
	
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-44806d547d596a7ad4a84a926b25d7d0">4 - ReentrantLock重入锁</h1>
    <div class="lead">java.util.concurrent.locks包提供的ReentrantLock用于替代synchronized加锁</div>
	<h4 id="重入性">重入性<a class="td-heading-self-link" href="#%e9%87%8d%e5%85%a5%e6%80%a7" aria-label="Heading self-link"></a></h4>
<meta name="baidu-site-verification" content="codeva-23xblvQ4Jb" /><p>重入性指当线程需要再次获取同一把锁时, 不会因为自身而造成死锁, 锁的本质是<strong>作用于代码块或方法</strong>，而不是线程的整个执行上下文。即使线程已经持有锁，进入新的同步方法或代码块时，仍然需要执行<strong>获取锁</strong>的操作，确保锁的计数正确。</p>
<p><img src="https://raw.githubusercontent.com/hamhuo-hub/HamPic/img/img/20250209113038176.png" alt="image.png"></p>
<p>所以支持重入性应该解决下列问题</p>
<ul>
<li>由于获得多次相同的锁, 需要计数以释放相同次数</li>
<li>相同线程再次获取锁应当直接成功, 防止死锁</li>
</ul>
<h4 id="为什么需要reentrantlock">为什么需要<code>ReentrantLock</code><a class="td-heading-self-link" href="#%e4%b8%ba%e4%bb%80%e4%b9%88%e9%9c%80%e8%a6%81reentrantlock" aria-label="Heading self-link"></a></h4>
<meta name="baidu-site-verification" content="codeva-23xblvQ4Jb" /><p>Java语言直接提供了<code>synchronized</code>关键字用于加锁，但这种锁一是很重，二是获取时必须一直等待，没有额外的尝试机制。</p>
<div class="highlight"><pre tabindex="0" style="color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ca9ee6">if</span> (lock.<span style="color:#8caaee">tryLock</span>(1, TimeUnit.<span style="color:#8caaee">SECONDS</span>)) {
</span></span><span style="display:flex;"><span>    <span style="color:#ca9ee6">try</span> {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>    } <span style="color:#ca9ee6">finally</span> {
</span></span><span style="display:flex;"><span>        lock.<span style="color:#8caaee">unlock</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>java.util.concurrent.locks</code>包提供的<code>ReentrantLock</code>用于替代<code>synchronized</code>加锁</p>
<p>尝试获取锁的时候，最多等待1秒。如果1秒后仍未获取到锁，<code>tryLock()</code>返回<code>false</code>，程序就可以做一些额外处理，而不是无限等待下去。</p>
<p>所以，使用<code>ReentrantLock</code>比直接使用<code>synchronized</code>更安全，线程在<code>tryLock()</code>失败的时候不会导致死锁。</p>
<h1 id="reentrantlock使用">ReentrantLock使用<a class="td-heading-self-link" href="#reentrantlock%e4%bd%bf%e7%94%a8" aria-label="Heading self-link"></a></h1>
<meta name="baidu-site-verification" content="codeva-23xblvQ4Jb" /><div class="highlight"><pre tabindex="0" style="color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#e78284">public</span> <span style="color:#e78284">class</span> <span style="color:#e5c890">Counter</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#737994;font-style:italic">//和关键字不同, 需要获得一个重入锁对象</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e78284">private</span> <span style="color:#e78284">final</span> Lock lock <span style="color:#99d1db;font-weight:bold">=</span> <span style="color:#ca9ee6">new</span> ReentrantLock();
</span></span><span style="display:flex;"><span>    <span style="color:#e78284">private</span> <span style="color:#e78284">int</span> count;
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>    <span style="color:#e78284">public</span> <span style="color:#e78284">void</span> <span style="color:#8caaee">add</span>(<span style="color:#e78284">int</span> n) {
</span></span><span style="display:flex;"><span>		<span style="color:#737994;font-style:italic">//代码块加锁</span>
</span></span><span style="display:flex;"><span>        lock.<span style="color:#8caaee">lock</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#ca9ee6">try</span> {
</span></span><span style="display:flex;"><span>            count <span style="color:#99d1db;font-weight:bold">+=</span> n;
</span></span><span style="display:flex;"><span>        } <span style="color:#ca9ee6">finally</span> {
</span></span><span style="display:flex;"><span>	        <span style="color:#737994;font-style:italic">//在finally中解锁</span>
</span></span><span style="display:flex;"><span>            lock.<span style="color:#8caaee">unlock</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
</div>



    
	
  



          </main>
        </div>
      </div>
      <footer class="td-footer row d-print-none">
  <div class="container-fluid">
    <div class="row mx-md-2">
      <div class="td-footer__left col-6 col-sm-4 order-sm-1">
        <ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="User mailing list" aria-label="User mailing list">
    <a target="_blank" rel="noopener" href="https://example.org/mail" aria-label="User mailing list">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Twitter" aria-label="Twitter">
    <a target="_blank" rel="noopener" href="https://example.org/twitter" aria-label="Twitter">
      <i class="fab fa-twitter"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Stack Overflow" aria-label="Stack Overflow">
    <a target="_blank" rel="noopener" href="https://example.org/stack" aria-label="Stack Overflow">
      <i class="fab fa-stack-overflow"></i>
    </a>
  </li>
  
</ul>

      </div><div class="td-footer__right col-6 col-sm-4 order-sm-3">
        <ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="GitHub" aria-label="GitHub">
    <a target="_blank" rel="noopener" href="https://github.com/hamhuo-hub/seaku" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Slack" aria-label="Slack">
    <a target="_blank" rel="noopener" href="https://example.org/slack" aria-label="Slack">
      <i class="fab fa-slack"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Developer mailing list" aria-label="Developer mailing list">
    <a target="_blank" rel="noopener" href="https://example.org/mail" aria-label="Developer mailing list">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
</ul>

      </div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2">
        <span class="td-footer__copyright">&copy;
    2025&ndash;2025
    <span class="td-footer__authors">海阔知识库 | <a href="https://creativecommons.org/licenses/by/4.0">CC BY 4.0</a> |</span></span><span class="td-footer__all_rights_reserved">All Rights Reserved</span><span class="ms-2"><a href="https://policies.google.com/privacy" target="_blank" rel="noopener">Privacy Policy</a></span>
      </div>
    </div>
  </div>
</footer>

    </div>
    <script src="/js/main.min.f72d00502781aaf278a14088eb2356b1ba2a05ad698a0c43fe86314d74ceab56.js" integrity="sha256-9y0AUCeBqvJ4oUCI6yNWsboqBa1pigxD/oYxTXTOq1Y=" crossorigin="anonymous"></script>
<script defer src="/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js" integrity="sha256-c0eKfUgHaYrtfjVesj&#43;YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin="anonymous"></script>
<script src='/js/tabpane-persist.js'></script>

  </body>
</html>
